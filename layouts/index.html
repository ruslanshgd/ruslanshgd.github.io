{{ define "main" }}
  {{ $casesSection := .Site.GetPage "section" "cases" }}
  {{ $cases := where $casesSection.RegularPages "Params.type" "case" }}
  <div class="home">
    <div class="home-hero-wrap">
    <section class="home-hero portfolio-content">
      {{ with site.Params.author_image }}
      <div class="home-hero__intro-image">
        <img src="{{ . | relURL }}" alt="{{ site.Params.author_name | default "–ê–≤—Ç–æ—Ä" }}">
      </div>
      {{ end }}
      <div class="home-hero__content">
        <h1 class="home-hero__title">
          –ü—Ä–∏–≤–µ—Ç, —è {{ site.Params.author_name | default "–ò–º—è" }}, {{ site.Params.author_grade | default "–ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä" }} <span class="home-hero__location">üìç {{ site.Params.author_city | default "–ì–æ—Ä–æ–¥" }}</span>
        </h1>
        {{ with site.Params.author_intro }}
        <div class="home-hero__intro-text">
          {{ . | safeHTML }}
        </div>
        {{ end }}
      </div>
    </section>
    </div>

    <section class="home-cases portfolio-content">
      {{/* Collect unique companies and platforms from cases */}}
      {{ $allCases := where $cases "Params.type" "case" }}
      {{ $companies := slice }}
      {{ $companySet := dict }}
      {{ $hasWeb := false }}
      {{ $hasMobile := false }}
      {{ range $allCases }}
        {{ with .Params.company_name }}
          {{ if and (ne . "") (not (isset $companySet .)) }}
            {{ $companySet = merge $companySet (dict . true) }}
            {{ $companies = $companies | append . }}
          {{ end }}
        {{ end }}
        {{ $platform := .Params.platform | default "web" }}
        {{ if eq $platform "web" }}{{ $hasWeb = true }}{{ end }}
        {{ if eq $platform "mobile" }}{{ $hasMobile = true }}{{ end }}
      {{ end }}
      {{ $companies = sort $companies }}
      
      {{/* Filters block */}}
      {{ if or (gt (len $companies) 0) $hasWeb $hasMobile }}
      <div class="cases-filters">
        <div class="cases-filters__companies">
          <button class="cases-filter-btn cases-filter-btn--company" data-filter="all" data-type="company">
            –í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏
          </button>
          {{ range $companies }}
          <button class="cases-filter-btn cases-filter-btn--company" data-filter="{{ . }}" data-type="company">
            {{ . }}
          </button>
          {{ end }}
        </div>
        <div class="cases-filters__platforms">
          {{ if and $hasWeb $hasMobile }}
          <button class="cases-filter-btn cases-filter-btn--platform" data-filter="all" data-type="platform">
            –í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
          </button>
          <button class="cases-filter-btn cases-filter-btn--platform" data-filter="web" data-type="platform">
            –í–µ–±
          </button>
          <button class="cases-filter-btn cases-filter-btn--platform" data-filter="mobile" data-type="platform">
            –ú–æ–±–∏–ª—å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          </button>
          {{ end }}
        </div>
      </div>
      {{ end }}
      
      <ul class="case-cards">
        {{ range $allCases }}
        {{ $page := . }}
        {{ $img := false }}
        {{ with $page.Params.card_image }}{{ $img = partial "get-image-resource.html" (dict "page" $page "path" . "context" "card") }}{{ end }}
        {{ if not $img }}{{ with $page.Params.cover_image }}{{ $img = partial "get-image-resource.html" (dict "page" $page "path" . "context" "cover") }}{{ end }}{{ end }}
        {{ if not $img }}{{ with $page.Params.cover_icon }}{{ $img = partial "get-image-resource.html" (dict "page" $page "path" . "context" "cover") }}{{ end }}{{ end }}
        {{ $platform := $page.Params.platform | default "web" }}
        {{ $layout := $page.Params.layout | default "center" }}
        {{ $imgWidth := 0 }}
        {{ if $img }}{{ $imgWidth = $img.Width }}{{ end }}
        {{ $companyName := $page.Params.company_name | default "" }}
        <li class="case-card case-card--{{ $platform }} case-card--layout-{{ $layout }}" 
            data-company="{{ $companyName }}" 
            data-platform="{{ $platform }}"
            {{ if and $img (le $imgWidth 768) }} data-image-width="{{ $imgWidth }}"{{ end }}>
          <a class="case-card__link" href="{{ $page.RelPermalink }}">
            <div class="case-card__body">
              {{ with $page.Params.company_name }}<p class="case-card__company">{{ . }}</p>{{ end }}
              <h2 class="case-card__title">{{ $page.Title }}</h2>
              {{ with $page.Params.cover_subtitle }}<p class="case-card__desc">{{ . }}</p>{{ end }}
            </div>
            <div class="case-card__image-wrap">
              {{ if $img }}
                <img class="case-card__image" src="{{ $img.RelPermalink }}" alt=""{{ if le $imgWidth 768 }} data-mobile="true"{{ end }}>
              {{ else }}
                <div class="case-card__image case-card__image--placeholder" aria-hidden="true"></div>
              {{ end }}
            </div>
          </a>
        </li>
        {{ end }}
      </ul>
    </section>

    {{ partial "career-section.html" . }}
    {{ partial "education-section.html" . }}
  </div>
{{ end }}
