{{ $page := . }}
{{ $p := $page.Params }}
{{ $platform := $p.platform | default "web" }}
{{ with $p.layout_blocks }}
<section class="case-section">
  <h2>Макеты</h2>
  {{ range . }}
  <div class="layout-block layout-block--{{ $platform }}" data-debug-figma="{{ if .figma_url }}present{{ else }}missing{{ end }}">
    {{ with .title }}<h3 class="layout-block__title">{{ . }}</h3>{{ end }}
    {{ with .text }}<p class="layout-block__text">{{ . }}</p>{{ end }}
    {{ with .images }}
    <div class="layout-block__images">
      {{ range . }}
        {{ $imgRes := partial "get-image-resource.html" (dict "page" $page "path" . "context" "layout") }}
        {{ if $imgRes }}
          {{ if eq $platform "mobile" }}
          <div class="layout-block__mockup layout-block__mockup--mobile">
            <div class="layout-block__mockup-inner">
              <div class="layout-block__mockup-screen">
                <img src="{{ $imgRes.RelPermalink }}" alt="">
              </div>
              <img class="layout-block__mockup-frame" src="{{ "images/frames/iphone.webp" | relURL }}" alt="" role="presentation" width="278" height="561">
            </div>
          </div>
          {{ else }}
          <div class="layout-block__mockup layout-block__mockup--web">
            <div class="layout-block__mockup-image-wrap">
              <img class="layout-block__mockup-img" src="{{ $imgRes.RelPermalink }}" alt="" data-full-src="{{ $imgRes.RelPermalink }}">
              <button type="button" class="layout-block__zoom-btn" aria-label="Открыть в полном размере">
                <i data-lucide="zoom-in" class="layout-block__zoom-icon"></i>
              </button>
            </div>
          </div>
          {{ end }}
        {{ else }}
          {{ if eq $platform "mobile" }}
          <div class="layout-block__mockup layout-block__mockup--mobile">
            <div class="layout-block__mockup-inner">
              <div class="layout-block__mockup-screen">
                <img src="{{ . | relURL }}" alt="">
              </div>
              <img class="layout-block__mockup-frame" src="{{ "images/frames/iphone.webp" | relURL }}" alt="" role="presentation" width="278" height="561">
            </div>
          </div>
          {{ else }}
          <div class="layout-block__mockup layout-block__mockup--web">
            <div class="layout-block__mockup-image-wrap">
              <img class="layout-block__mockup-img" src="{{ . | relURL }}" alt="" data-full-src="{{ . | relURL }}">
              <button type="button" class="layout-block__zoom-btn" aria-label="Открыть в полном размере">
                <i data-lucide="zoom-in" class="layout-block__zoom-icon"></i>
              </button>
            </div>
          </div>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>
    {{ end }}
    {{ with .figma_url }}
      {{/* Embed URL: replace www/figma with embed.figma.com, add embed-host (required), device-frame=false (we use our iPhone mockup) */}}
      {{ $base := . | replace "https://www.figma.com" "https://embed.figma.com" | replace "https://figma.com" "https://embed.figma.com" }}
      {{ $src := $base }}
      {{ if and $base (hasPrefix $base "https://embed.figma.com") }}
        {{ if not (in $base "embed-host=") }}
          {{ if in $base "?" }}{{ $src = printf "%s&embed-host=share&device-frame=false" $base }}{{ else }}{{ $src = printf "%s?embed-host=share&device-frame=false" $base }}{{ end }}
        {{ else }}
          {{ if not (in $base "device-frame=") }}{{ $src = printf "%s&device-frame=false" $base }}{{ end }}
        {{ end }}
      {{ end }}
      {{ if eq $platform "mobile" }}
      <div class="layout-block__mockup layout-block__mockup--mobile">
        <div class="layout-block__mockup-inner">
          <div class="layout-block__mockup-screen">
            <iframe src="{{ $src }}" allowfullscreen loading="lazy" width="100%" height="494" style="min-height: 400px;"></iframe>
          </div>
          <img class="layout-block__mockup-frame" src="{{ "images/frames/iphone.webp" | relURL }}" alt="" role="presentation" width="278" height="561">
        </div>
      </div>
      {{ else }}
      <div class="layout-block__mockup layout-block__mockup--web">
        <div class="layout-block__figma-wrap">
          <iframe src="{{ $src }}" allowfullscreen loading="lazy" width="100%" height="450" style="min-height: 400px;"></iframe>
        </div>
      </div>
      {{ end }}
    {{ end }}
  </div>
  {{ end }}
  {{ with $p.before_after }}
  <div class="before-after">
    <div>
      <strong>Было</strong>
      <p>{{ .before }}</p>
    </div>
    <div>
      <strong>Стало</strong>
      <p>{{ .after }}</p>
      {{ with .metric }}<p class="before-after__metric">{{ . }}</p>{{ end }}
    </div>
  </div>
  {{ end }}
</section>
  <div id="layout-modal" class="layout-modal" aria-hidden="true">
  <div class="layout-modal__backdrop"></div>
  <div class="layout-modal__content">
    <button type="button" class="layout-modal__close" aria-label="Закрыть">
      <i data-lucide="x"></i>
    </button>
    <img class="layout-modal__img" src="" alt="">
  </div>
</div>
<script src="https://unpkg.com/lucide@0.460.0/dist/umd/lucide.min.js"></script>
<script src="{{ "js/layout-blocks.js" | relURL }}"></script>
{{ end }}
